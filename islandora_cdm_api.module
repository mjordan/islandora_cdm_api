<?php

/**
 * @file
 * The main Islandora CONTENTdm API module file.
 */

/**
 * Implements hook_menu().
 */
function islandora_cdm_api_menu() {
  $items = array();
  $items['admin/islandora/tools/cdm_api'] = array(
    'title' => 'CONTENTdm API Provider',
    'description' => 'Configure the Islandora CONTENTdm API Provider module.',
    'page callback' => 'drupal_get_form',
    'access arguments' => array('administer site configuration'),
    'page arguments' => array('islandora_cdm_api_admin_settings'),
    'type' => MENU_NORMAL_ITEM,
  );
  // We can't use ordinary menu paths for most of the CONTENTdm API URLs
  // because Drupal menu paths have a maximum of 9 path segments. See
  // https://api.drupal.org/api/drupal/includes!menu.inc/constant/MENU_MAX_PARTS/7.
  // To get around this, we consider everything in the incoming request's
  // query (?c=) to be a single string that we parse to get the "parameters".
  $items['cdm_api'] = array(
    'title' => 'CONTENTdm API',
    'description' => '',
    'page callback' => 'islandora_cdm_api_router',
    'access arguments' => array('access contentdm api'),
    'type' => MENU_LOCAL_TASK,
  );
  $items['cdm_api/utils/getfile/collection/%/id/%/filename/%'] = array(
    'title' => 'GetFile',
    'description' => '',
    'page callback' => 'islandora_cdm_api_getfile',
    'page arguments' => array(4, 6, 8),
    'access arguments' => array('access contentdm api'),
    'type' => MENU_LOCAL_TASK,
  );
  $items['cdm_api/utils/ajaxhelper'] = array(
    'title' => 'GetImage',
    'description' => '',
    'page callback' => 'islandora_cdm_api_getimage',
    'access arguments' => array('access contentdm api'),
    'type' => MENU_LOCAL_TASK,
  );
  $items['cdm_api/utils/getstream/collection/%/id/%'] = array(
    'title' => 'GetStream',
    'description' => '',
    'page callback' => 'islandora_cdm_api_getstream',
    'page arguments' => array(4, 6),
    'access arguments' => array('access contentdm api'),
    'type' => MENU_LOCAL_TASK,
  );
  $items['cdm_api/utils/getthumbnail/collection/%/id/%'] = array(
    'title' => 'GetThumbnail',
    'description' => '',
    'page callback' => 'islandora_cdm_api_getthumbnail',
    'page arguments' => array(4, 6),
    'access arguments' => array('access contentdm api'),
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function islandora_cdm_api_permission() {
  return array(
    'access contentdm api' => array(
      'title' => t('Access CONTENTdm API'),
      'description' => t('Access the CONTENTdm API'),
    ),
  );
}

/**
 * Admin settings form builder.
 */
function islandora_cdm_api_admin_settings() {
  $form = array();
  $form['islandora_cdm_api_source_cdm_url'] = array(
    '#title' => t('Source CONTENTdm server hostname'),
    '#type' => 'textfield',
    '#size' => 60,
    '#default_value' => variable_get('islandora_cdm_api_source_cdm_url', 'http://contentdm.example.com'),
    '#description' => t('The hostname of the CONTENTdm server that the Islandora objects were migrated from, including the "http://" or "https://" but without the trailing slash. Used in querying your objects to retrieve PIDs.'),
    '#maxlength' => 60,
  );
  $form['islandora_cdm_api_identifier_element'] = array(
    '#title' => t('Identifier element'),
    '#type' => 'textfield',
    '#size' => 60,
    '#default_value' => variable_get('islandora_cdm_api_identifier_element', 'dc.identifier'),
    '#description' => t('The element to specify in the Solr query.'),
    '#maxlength' => 60,
  );
  return system_settings_form($form);
}

/**
 * Grabs the query string from the request and passes it off to the appropriate
 * function. We need to use a query string instead of menu path elements since
 * Drupal 7 only allows 9 of these, and dmQuery requires more than that. See
 * https://api.drupal.org/api/drupal/includes!menu.inc/constant/MENU_MAX_PARTS/7
 * for the Drupal menu limitation. So we handle all of the API requests the same
 * way, we route them through a single menu callback.
 */
function islandora_cdm_api_router() {
  $not_recognized_message = t('Your request to the CONTENTdm API was not recognized.');
  $query = drupal_get_query_parameters();
  if (!count($query)) {
      return $not_recognized_message;
  }

  // The string we want is the only key ('c') in the query.
  $query_string = $query['c'];
  $params = explode('/', $query_string);
  // Get the first item after the question mark and pass the remainder
  // of the exploded string to the switch.
  $verb = array_shift($params);

  switch ($verb) {
    case 'dmGetCollectionsList':
      islandora_cdm_api_dmgetcollectionslist($params);
      break;
    case 'dmGetDublinCoreFieldInfo':
      islandora_cdm_api_dmgetdublincorefieldinfo($params);
      break;
    case 'dmGetCollectionFieldInfo':
      islandora_cdm_api_dmgetcollectionfieldinfo($params);
      break;
    case 'dmGetCollectionParameters':
      islandora_cdm_api_dmgetcollectionparameters($params);
      break;
    case 'dmGetCompoundObjectInfo':
      islandora_cdm_api_dmgetcompoundobjectinfo($params);
      break;
    case 'dmGetImageInfo':
      islandora_cdm_api_dmgetimageinfo($params);
      break;
    case 'dmGetItemInfo':
      islandora_cdm_api_dmgetiteminfo($params);
      break;
    case 'dmQuery':
      islandora_cdm_api_dmquery($params);
      break;
    case 'GetItemDmmodified':
      islandora_cdm_api_getitemdmmodified($params);
      break;
    case 'GetParent':
      islandora_cdm_api_getparent($params);
      break;
    default:
      return $not_recognized_message;
  }
}

function islandora_cdm_api_dmgetcollectionslist($params) {
  $data = array('dmGetCollectionsList', $params);
  drupal_json_output($data);
}

function islandora_cdm_api_dmgetdublincorefieldinfo($params) {
  $data = array('dmGetDublinCoreFieldInfo', $params);
  drupal_json_output($data);
}

function islandora_cdm_api_dmgetcollectionfieldinfo($params) {
  // $alias, $format
  $data = array('dmGetCollectionFieldInfo', $params);
  drupal_json_output($data);
}

function islandora_cdm_api_dmgetcollectionparameters($params) {
  // $alias, $format
  $data = array('dmGetCollectionParameters', $params);
  drupal_json_output($data);
}

function islandora_cdm_api_dmgetcompoundobjectinfo($params) {
  // $alias, $pointer, $format
  $islandora_object_pid = islandora_cdm_api_map_request_to_pid($params[0], $params[1]);
  $data = array('dmGetCompoundObjectInfo', $params);
  drupal_json_output($data);
}

function islandora_cdm_api_dmgetimageinfo($params) {
  // $alias, $pointer, $format
  $islandora_object_pid = islandora_cdm_api_map_request_to_pid($params[0], $params[1]);
  $data = array('dmGetImageInfo', $params);
  drupal_json_output($data);
}

function islandora_cdm_api_dmgetiteminfo($params) {
  // $alias, $pointer, $format
  $islandora_object_pid = islandora_cdm_api_map_request_to_pid($params[0], $params[1]);
  $data = array('dmGetItemInfo', $params);
  drupal_json_output($data);
}

function islandora_cdm_api_dmquery($params) {
  // $alias = '', $searchstrings = '', $fields = '', $sortby = '', $maxrecs = '1024', $start = '0', $supress = '0', $docptr = '0', $suggest = '0', $facets = '0', $showunpub = '0', $denormalizedFacets = '0', $format = 'json'
  $data = array('dmQuery', $params);
  drupal_json_output($data);
}

function islandora_cdm_api_getitemdmmodified($params) {
  // $alias, $pointer, $format
  $islandora_object_pid = islandora_cdm_api_map_request_to_pid($params[0], $params[1]);
  $data = array('GetItemDmmodified', $params);
  drupal_json_output($data);
}

function islandora_cdm_api_getparent($params) {
  // $alias, $pointer, $format
  $islandora_object_pid = islandora_cdm_api_map_request_to_pid($params[0], $params[1]);
  $data = array('GetParent', $params);
  drupal_json_output($data);
}

/*
 The file functions should use the following:

 module_load_include('inc', 'islandora', 'includes/datastream');
 islandora_download_datastream($datastream);
*/

function islandora_cdm_api_getfile($params) {
  // $alias, $pointer, $format, $filename
  $islandora_object_pid = islandora_cdm_api_map_request_to_pid($params[0], $params[1]);
  $data = array('GetFile', $params);
  drupal_json_output($data);
}

/**
 * GetImage uses $_GET, not menu arguments.
 */
function islandora_cdm_api_getimage() {
  $data = drupal_get_query_parameters();
  drupal_json_output(array('Request' => 'GetImage') + $data);
}

function islandora_cdm_api_getstream($alias = '', $pointer = '') {
  $islandora_object_pid = islandora_cdm_api_map_request_to_pid($alias, $pointer);
  $data = array('GetStream', $alias, $pointer);
  drupal_json_output($data);
}

function islandora_cdm_api_getthumbnail($alias = '', $pointer = '') {
  $islandora_object_pid = islandora_cdm_api_map_request_to_pid($alias, $pointer);
  $data = array('GetThumbnail', $alias, $pointer);
  drupal_json_output(array('Request' => 'getthumbnail') + $data);
}

/**
 * Return the PID of the Islandora object corresponding to the alias and pointer.
 * Performs a query to Islandora's Solr index to get the PID.
 *
 * @param string $alias
 *   The CONTENTdm collection alias
 * @param string $pointer
 *   The CONENTdm object pointer
 */
function islandora_cdm_api_map_request_to_pid($alias = '', $pointer = '') {
  $solr_url = variable_get('islandora_solr_url', 'http://localhost:8080/solr');
  $source_cdm_server_url = variable_get('islandora_cdm_api_source_cdm_url', 'http://contentdm.example.com');
  $target_element = variable_get('islandora_cdm_api_identifier_element', 'dc.identifier');
  $pid_query = $solr_url . '/select?version=1.2&wt=json&json.nl=map&q=' . $target_element . ':' .
    '%22' . $source_cdm_server_url . '/cdm/ref/collection/' . $alias . '/id/' . $pointer . '%22';
  debug($pid_query);
  $raw_result = drupal_http_request($pid_query);
  if ($raw_result->code != 200) {
    return FALSE;
  }
  $query_result = json_decode($raw_result->data);
  if ($query_result->response->numFound < 1) {
    return FALSE;
  } 
  // If more than one object was found, take the PID of the first one.
  return $query_result->response->docs[0]->PID;
}

