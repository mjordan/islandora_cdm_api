<?php

/**
 * @file
 * Attempts to ingest some image into a randomly generated image collection
 * and perform lookups on their CONTENTdm URLs.
 */

class IslandoraCdmApiTestCase extends IslandoraCollectionWebTestCase {

  /**
   * Get test information.
   *
   * @see IslandoraWebTestCase::getInfo()
   */
  public static function getInfo() {
    return array(
      'name' => 'CONTENTdm API tests',
      'description' => 'Tests basic functionality of the Islandora CONTENTdm API',
      'group' => 'Islandora CONTENTdm API',
    );
  }

  /**
   * Set up the test environment.
   *
   * @see IslandoraWebTestCase::setUp()
   */
  public function setUp() {
    parent::setUp(array(
      'islandora',
      'islandora_basic_image',
      'islandora_basic_collection',
      'islandora_solr',
      'islandora_cdm_api',
    ));
  }

  /**
   * Ingests objects that we use in our CONTENTdm API tests.
   */
  public function testIngestObjects() {
    $user = $this->drupalCreateUser(array(
      'view fedora repository objects',
      'ingest fedora objects',
      'administer site configuration',
      'manage object properties',
      'delete fedora objects and datastreams',
      'create child collection',
    ));
    $this->drupalLogin($user);

    // Attempts to create collection.
    $collection_pid = 'islandora%3Acdm_api_test_collection';
    $this->createTestCollection('Test collection', 'islandora:sp_basic_image', $collection_pid);

    $test_file_basenames = array('image1', 'image2', 'image3');
    foreach ($test_file_basenames as $basename) {
      // Attempts to create an object with an image file.
      $path = 'islandora/object/' . $collectionpid . '/manage/overview/ingest';
      $image_file = drupal_get_path('module', 'islandora_cdm_api') . '/tests/fixtures/' . $basename . '.jpg';
      $image_handle = fopen($image_file, "r");
      $contents = fread($image_handle, filesize($image_file));
      fclose($image_handle);
      $edit = array(
        'files[file]' => $image_file,
      );
      $this->drupalPost($path, $edit, t('Ingest'));
      $this->assertText('New Object', 'Image object was created', 'Islandora');
      $path = $this->url;
      $image_path = $path . '/datastream/OBJ/view';
      $this->assertLinkByHref($image_path, 0, t('Ingested image found on view page'), t('Islandora'));

      // Attempts to upload a MODS datastream for the object.
      $mods_upload_path = $path . '/manage/datastreams/add';
      $mods_file = drupal_get_path('module', 'islandora_cdm_api') . '/tests/fixtures/' . $basename . '.xml';
      $mods_handle = fopen($mods_file, "r");
      $contents = fread($mods_handle, filesize($mods_file));
      fclose($mods_handle);
      $edit = array(
        'dsid' => 'MODS',
        'label' => 'MODS record',
        'files[file]' => $mods_file,
      );
      $this->drupalPost($mods_upload_path, $edit, t('Add Datastream'));
      $mods_path = $this->url . '/datastream/MODS/view';
      $this->assertLinkByHref($mods_path);
    }
  }

  /**
   * Tests dmGetDublinCoreFieldInfo API call.
   */
  public function testdmGetDublinCoreFieldInfo() {
    $user = $this->drupalCreateUser(array_keys(module_invoke_all('permission')));
    $this->drupalLogin($user);

    $this->drupalGet('cdm_api?c=dmGetDublinCoreFieldInfo/xml');
    $this->assertPattern('|<name>Title</name>|');

    $this->drupalGet('cdm_api?c=dmGetDublinCoreFieldInfo/json');
    $this->assertPattern('|"name":"Title"|');
  }

  /**
   * Tests GetItemDmmodified API call.
   */
  public function testGetItemDmmodified() {
    $user = $this->drupalCreateUser(array_keys(module_invoke_all('permission')));
    $this->drupalLogin($user);

    $this->drupalGet('cdm_api?c=GetItemDmmodified/testcoll1/100/json');
    $this->assertPattern('|\d\d\d\d\|', 'Date is present');

    $this->drupalGet('cdm_api?c=GetItemDmmodified/testcoll2/200/json');
    $this->assertPattern('|\d\d\d\d\|', 'Date is present');

    $this->drupalGet('cdm_api?c=GetItemDmmodified/testcoll3/300/json');
    $this->assertPattern('|\d\d\d\d\|', 'Date is present');

    $this->drupalGet('cdm_api?c=GetItemDmmodified/testcoll3/300/xml');
    $this->assertPattern('|Sorry,\soutput\sfor\sdmGetItemDmmodified|',
      'XML error message is present');
  }

  /**
   * Tests dmGetImageInfo API call.
   */
  public function testDmGetImageInfo() {
    $user = $this->drupalCreateUser(array_keys(module_invoke_all('permission')));
    $this->drupalLogin($user);

    $this->drupalGet('cdm_api?c=dmGetImageInfo/testcoll1/100/xml');
    $this->assertPattern('|<width>\d+</width>|', 'Image width is present');

    $this->drupalGet('cdm_api?c=dmGetImageInfo/testcoll2/200/xml');
    $this->assertPattern('|<width>\d+</width>|', 'Image width is present');

    $this->drupalGet('cdm_api?c=dmGetImageInfo/testcoll3/300/xml');
    $this->assertPattern('|<width>\d+</width>|', 'Image width is present');
  }

  /**
   * Tests GetThumbnail API call.
   */
  public function testGetThumbnail() {
    $user = $this->drupalCreateUser(array_keys(module_invoke_all('permission')));
    $this->drupalLogin($user);

    $this->drupalGet('cdm_api/utils/getthumbnail/collection/testcoll1/id/100');
    $this->assertResponse(200, 'Response OK');
    $header1 = $this->drupalGetHeader('Content-Type');
    $this->assertEqual($header1, 'image/jpeg', 'Content-Type header on thumbnail is image/jpeg');

    $this->drupalGet('cdm_api/utils/getthumbnail/collection/testcoll2/id/200');
    $this->assertResponse(200, 'Response OK');
    $header2 = $this->drupalGetHeader('Content-Type');
    $this->assertEqual($header2, 'image/jpeg', 'Content-Type header on thumbnail is image/jpeg');

    $this->drupalGet('cdm_api/utils/getthumbnail/collection/testcoll3/id/300');
    $this->assertResponse(200, 'Response OK');
    $header3 = $this->drupalGetHeader('Content-Type');
    $this->assertEqual($header3, 'image/jpeg', 'Content-Type header on thumbnail is image/jpeg');
  }

  /**
   * Tests getfile utility call.
   */
  public function testGetfile() {
    $user = $this->drupalCreateUser(array_keys(module_invoke_all('permission')));
    $this->drupalLogin($user);

    $this->drupalGet('cdm_api/utils/getfile/collection/testcoll1/id/100/filename/foo.jpg');
    $this->assertResponse(200, 'Response OK');
    $header1 = $this->drupalGetHeader('Content-Type');
    $this->assertEqual($header1, 'Application/octet-stream');

    $this->drupalGet('cdm_api/utils/getfile/collection/testcoll2/id/200/filename/foo.jpg');
    $this->assertResponse(200, 'Response OK');
    $header2 = $this->drupalGetHeader('Content-Type');
    $this->assertEqual($header2, 'Application/octet-stream');

    $this->drupalGet('cdm_api/utils/getfile/collection/testcoll3/id/300/filename/foo.jpg');
    $this->assertResponse(200, 'Response OK');
    $header3 = $this->drupalGetHeader('Content-Type');
    $this->assertEqual($header3, 'Application/octet-stream');
  }
}
